<!-- Host your data, perform a sql query, spatial query, better performance with a VTL-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>OpenLayers Tutorials: Display a map</title>

    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color: #323232;
      }

      #query-select {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 4px 8px;
        font-size: 16px;
        border-radius: 0; /* Causes more uniform appearance across browsers. */
      }

    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.7.0/css/ol.css" type="text/css" />
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.7.0/build/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-mapbox-style@6.1.4/dist/olms.js" type="text/javascript"></script>

    <script src="https://unpkg.com/@esri/arcgis-rest-request@3.0.0/dist/umd/request.umd.js"></script>
    <script src="https://unpkg.com/@esri/arcgis-rest-feature-layer@3.0.0/dist/umd/feature-layer.umd.js"></script>
    <script src="https://unpkg.com/ol-popup@4.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/ol-popup@4.0.0/src/ol-popup.css" />

  </head>

  <body>
    <div id="map"></div>
    <select id="query-select">
      <option value="1=1" selected>Choose a WHERE clause...</option>
      <option value="Condition = 'Poor'">Condition= 'Poor'</option>
      <option value="Condition = 'Good'">Condition = 'Good'</option>
    </select>
    <script>

      const apiKey = "AAPK59169138d2654245bc0b04d5fc41c6b6QCRoNIqod5z5w7u8g2AIE5kJVQG1Mzq_BB9uqc554GluBHOyln0FCDRvezu9jVFM";

      const map = new ol.Map({
        target: "map"
      });

      map.setView(
        new ol.View({
          center: ol.proj.fromLonLat([-122, 45]),
          zoom: 12
        })
      );

      const basemapId = "ArcGIS:Streets";
      const basemapURL = "https://basemaps-api.arcgis.com/arcgis/rest/services/styles/" + basemapId + "?type=style&token=" + apiKey;

      const parcelLayer = new ol.layer.Vector();
      olms(map, basemapURL).then((map) => {

        map.addLayer(parcelLayer);

      });

      // Query SQL 

      function executeQuery(whereClause, geometry) {
        arcgisRest
          .queryFeatures({
            url: "https://services8.arcgis.com/87xMVlxSyDt491tZ/arcgis/rest/services/street_trees_pdx/FeatureServer/0",
            geometry: geometry,
            geometryType: "esriGeometryEnvelope",
            inSR: 4326, // EPSG:4326 uses latitudes and longitudes
            spatialRel: "esriSpatialRelIntersects",
            where: whereClause,

            f: "geojson",
            returnGeometry: true,
            outFields: ["Condition", "Common"]
          })

          .then((response) => {
            const geojson = new ol.format.GeoJSON({
              defaultDataProjection: "EPSG:4326",
              featureProjection: "EPSG:3857"
            });

            let newSource = new ol.source.Vector({
              features: geojson.readFeatures(response)
            });
            parcelLayer.setSource(newSource);
          });

      }

      // Listen for changes
      const select = document.getElementById("query-select");
      select.addEventListener("change", () => {
        const whereClause = select.value;

        const extent3857 = map.getView().calculateExtent(map.getSize());
        const extent4326 = ol.proj.transformExtent(extent3857, "EPSG:3857", "EPSG:4326");
        executeQuery(whereClause, extent4326);
      });
    </script>
  </body>
</html>
